package Strategy;

import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.OutputStream;

import Client.Client;
import Exceptions.RequestException;
import Serveur.FtpRequest;

public class RequestRETR implements Request{

	public void doRequest(FtpRequest ftp, String[] request)
			throws RequestException {
		/* Test si l'usage est correct */
		if (request.length != 2) {
			ftp.getWriter().println("USAGE : RETR filename");
			return;
		}
		/* Test si le client est connect√© */
		Client c = ftp.getClient();
		if(c == null){
			ftp.getWriter().println("Veuillez vous connecter.");
			return;
		}else{
			if(!c.isConnected()){
				ftp.getWriter().println("Veuillez vous connecter.");
				return;
			}
		}
		/* Test les droits du client */
		if(!ftp.getClient().canRead()){
			ftp.getWriter().println(550 + " pas de droit de lecture.");
    		return;
		}
		
		ftp.getWriter().println(150 + " Files OK, open Data Connection in ASCII"); 
		
		FileInputStream fis = null;
		OutputStream os = null;
		try {
			// Opens file
			fis = new FileInputStream(ftp.getPathname() + request[1]);
			// Opens connection
			ftp.sendMessage("150 File status okay; about to open data connection");
			os = ftp.getDataService().openDataStream(2)().getOutputStream();
			// Sends through data socket
			byte[] buffer = new byte[1024];
			int nbBytes = 0;
			while ((nbBytes = fis.read(buffer)) != -1) {
				os.write(buffer, 0, nbBytes);
			}
			// Closes connection
			ftp.sendCommand("226 Closing data connection");
			ftp.getDataConnectionService().close();
		} catch (FileNotFoundException e) {
			ftp.sendCommand("550 Requested action not taken; file unavailable");
		} catch (IOException ignore) {
			// Closes connection if error during write
			ftp.sendCommand("426 Connection closed, transfer aborted");
			ftp.getDataConnectionService().close();
		} finally {
			try { fis.close(); } catch(Exception ignore) {};
			try { os.close(); } catch(Exception ignore) {};
		}
	}

	

}
