package Strategy;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;

import Client.Client;
import Exceptions.RequestException;
import Serveur.FtpRequest;

public class RequestLIST implements Request {

	public void doRequest(FtpRequest ftp, String[] request)
			throws RequestException {
		Client c = ftp.getClient();
		/* Test si l'usage est correct */
		if (request.length != 1) {
			ftp.getWriter().println("USAGE : LIST");
			return;
		}
		/* Test si le client est connecté */
		if(c == null){
			ftp.getWriter().println("Veuillez vous connecter.");
			return;
		}else{
			if(!c.isConnected()){
				ftp.getWriter().println("Veuillez vous connecter.");
				return;
			}
		}
		/* Test des droit */
		if (!ftp.getClient().canRead()) {
			ftp.getWriter().println(425 + " Restriction au niveau des droits");
			return;
			// throw new RequestDroitException(ftp);
		}

		OutputStream output = null;
		try {
			// Opens connection
			ftp.sendMessage("150 File status okay; about to open data connection");

			int port = 21;

			ftp.getDataService().openDataStream(port);
			output = ftp.getDataService().getDataStream();
			System.out.println();

			InputStream input = Runtime.getRuntime()
					.exec(new String[] { "ls", "-l", ftp.getPathname() })
					.getInputStream();

			// Envoie de la liste des fichiers sur le canal de données
			final BufferedReader reader = new BufferedReader(
					new InputStreamReader(input));

			String line;
			while ((line = reader.readLine()) != null) {
				ftp.sendMessage(line);
			}

			ftp.sendMessage("226 Closing data connection");
			ftp.getDataService().closeDataStream();

		} catch (IOException ignore) {
			ftp.sendMessage("426 Connection closed, transfer aborted");
			ftp.getDataService().closeDataStream();
		} finally {
			try {
				output.close();
			} catch (Exception ignore) {
			}
		}

	}

}
